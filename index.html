# üëá Installation automatique si ccxt n'est pas pr√©sent
try:
    import ccxt
except ImportError:
    !pip install ccxt
    import ccxt

import time
from IPython.display import clear_output

# Liste fixe des cryptos
crypto_options = {
    '1': 'BTC/USDT',
    '2': 'ETH/USDT',
    '3': 'SOL/USDT',
    '4': 'XRP/USDT',
    '5': 'ADA/USDT'
}

# Menu de s√©lection
print("üìå S√©lectionne une cryptomonnaie √† surveiller :")
for k, v in crypto_options.items():
    print(f"{k}. {v}")
choice = input("‚û°Ô∏è Entrez le num√©ro : ").strip()
selected_symbol = crypto_options.get(choice)

if not selected_symbol:
    print("‚ùå Choix invalide. Arr√™t.")
else:
    print(f"\nüîç Crypto s√©lectionn√©e : {selected_symbol}")

    # 10 Exchanges CCXT (Binance exclu, Bitget inclus)
    exchanges = [
        ccxt.bitget(),
        ccxt.kraken(),
        ccxt.kucoin(),
        ccxt.coinbase(),
        ccxt.bitfinex(),
        ccxt.bitstamp(),
        ccxt.gate(),
        ccxt.huobi(),
        ccxt.okx(),
        ccxt.bybit()
    ]

    def fetch_prices(symbol):
        results = []
        for ex in exchanges:
            try:
                ticker = ex.fetch_ticker(symbol)
            except Exception:
                try:
                    alt_symbol = symbol.replace('USDT', 'USD')
                    ticker = ex.fetch_ticker(alt_symbol)
                except:
                    continue
            bid = ticker.get('bid')
            ask = ticker.get('ask')
            if bid and ask:
                results.append((ex.id, bid, ask))
        return results

    # Rafra√Æchissement continu
    while True:
        clear_output(wait=True)
        print(f"üìà Crypto : {selected_symbol} - Mise √† jour toutes les 60s\n")

        data = fetch_prices(selected_symbol)
        if not data:
            print("‚ö†Ô∏è Aucune donn√©e r√©cup√©r√©e.")
        else:
            # Trier par prix de vente (ask) d√©croissant
            data.sort(key=lambda x: x[2], reverse=True)
            min_ask = min([x[2] for x in data])
            max_bid = max([x[1] for x in data])
            spread = max_bid - min_ask
            spread_pct = (spread / min_ask) * 100

            print(f"üí∞ Meilleur PRIX D'ACHAT (ask min) : {min_ask:.6f} USD")
            print(f"üí∏ Meilleur PRIX DE VENTE (bid max): {max_bid:.6f} USD")
            print(f"üìä Spread (prix) : {spread:.6f} USD")
            print(f"üìà Spread (%)   : {spread_pct:.4f} %\n")

            print(f"{'Exchange':<12} {'Bid (achat)':>15} {'Ask (vente)':>15}")
            print("-" * 45)
            for ex_id, bid, ask in data:
                print(f"{ex_id:<12} {bid:>15.6f} {ask:>15.6f}")

        print("\n‚è≥ Attente 60 secondes avant la prochaine mise √† jour...")
        time.sleep(60)


